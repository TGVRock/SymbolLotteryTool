<!DOCTYPE html>
<html lang="ja">

<head>
	<title>secret base</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      visibleElement('inputArea');
      // クエリパラメータでデータが与えられている場合は自動読み込み
      const searchParams = new URLSearchParams(window.location.search);
      if (!searchParams.has('targetAddress') || !searchParams.has('netType')) {
        return;
      }
      
      // パラメータの取得と検証
      const queryAddress = searchParams.get('targetAddress');
      const queryNetType = searchParams.get('netType');
      netType = -1;
      switch (queryNetType) {
        case '104':
        case 'main':
          netType = "104";
          break;

        case '152':
        case 'test':
          netType = "152";
          break;

        default:
          return;
      }
      document.forms.formMosaic.inputAddress.value = queryAddress;
      document.forms.formMosaic.inputNetType.value = netType;
    });
  </script>
  <style>
    .list-group-item-election-1 {
      color: #055160;
      background-color: #cff4fc;
    }
    .list-group-item-election-2 {
      color: #084298;
      background-color: #cfe2ff;
    }
    .list-group-item-election-3 {
      color: #0f5132;
      background-color: #d1e7dd;
    }
    .list-group-item-election-4 {
      color: #664d03;
      background-color: #fff3cd;
    }
    .list-group-item-election-5 {
      color: #842029;
      background-color: #f8d7da;
    }
    .list-group-item-election-6 {
      color: #ff0022;
      background-color: #fcfcfc;
    }
  </style>
</head>

<body id="top">
	<article>
    <section class="container d-none" id="inputArea">
      <form id="formMosaic">
        <div class="mb-3 row">
          <label for="inputAddress" class="col-sm-12 col-form-label">Address</label>
          <div class="col-sm-3">
            <select class="form-select" id="inputNetType" aria-label="Select NET Type">
              <option selected value="104">MAIN NET</option>
              <option value="152">TEST NET</option>
            </select>
          </div>
          <div class="col-sm-9">
            <input type="text" class="form-control" id="inputAddress" placeholder="Input Address...">
          </div>
        </div>
        <div class="mb-3 row">
          <div class="col-4 text-center">
            <button type="button" class="btn btn-primary" id="buttonStart" onclick="onListenStartClick()">
              Start Listen
            </button>
          </div>
          <div class="col-4 text-center">
            <button type="button" class="btn btn-primary" id="buttonStop" disabled onclick="onListenStopClick()">
              Stop Listen
            </button>
          </div>
          <div class="col-4 text-center">
            <button type="button" class="btn btn-primary" id="buttonLottery" disabled onclick="onExecuteLottery()">
              Lottery
            </button>
          </div>
          <div class="col-12 text-center mt-2">
            <button type="button" class="btn btn-primary d-none" id="buttonTransfer" onclick="onExecuteTransfer()">
              [For Only Test] Open Fauset
            </button>
          </div>
        </div>
      </form>
    </section>
    <section class="container text-break" id='addressListArea'>
      <ul class="list-group list-group-flush">
        <li class="list-group-item">
          <div class="row"><div class="col-4">time</div><div class="col-8">address</div></div>
        </li>
        <li class="list-group-item list-group-item-election-1">
          <div class="row"><div class="col-4">time</div><div class="col-8">1st election address</div></div>
        </li>
        <li class="list-group-item list-group-item-election-2">
          <div class="row"><div class="col-4">time</div><div class="col-8">2nd election address</div></div>
        </li>
        <li class="list-group-item list-group-item-election-3">
          <div class="row"><div class="col-4">time</div><div class="col-8">3rd election address</div></div>
        </li>
        <li class="list-group-item list-group-item-election-4">
          <div class="row"><div class="col-4">time</div><div class="col-8">4th election address</div></div>
        </li>
        <li class="list-group-item list-group-item-election-5">
          <div class="row"><div class="col-4">time</div><div class="col-8">5th election address</div></div>
        </li>
        <li class="list-group-item list-group-item-election-6">
          <div class="row"><div class="col-4">time</div><div class="col-8">6th election address</div></div>
        </li>
      </ul>
    </section>
    <section class="d-none" id="loadArea">
      <div class="position-fixed top-50 start-50 translate-middle bg-white vw-100 vh-100"></div>
      <div class="position-fixed top-50 start-50 translate-middle text-center">
        <h3 class="animate__animated animate__bounce animate__infinite">Now Lottery... </h3>
        <div class="spinner-border text-secondary" role="status">
          <span class="visually-hidden">Now Lottery...</span>
        </div>
      </div>
    </section>

    <!-- <div class="toast-container">
      <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Transfer Transaction</strong>
          <small class="text-muted">just now</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          See? Just like this.
        </div>
      </div>
    
      <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Bootstrap</strong>
          <small class="text-muted">2 seconds ago</small>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Heads up, toasts will stack automatically
        </div>
      </div>
    </div> -->
  </article>
</body>
<script src="resource/bundle.min.js"></script>
<script>
  let intervalId = null;
  async function onListenStartClick() {
    document.forms.formMosaic.inputAddress.disabled = true;
    document.forms.formMosaic.inputNetType.disabled = true;
    document.forms.formMosaic.buttonStart.disabled = true;
    document.forms.formMosaic.buttonStop.disabled = false;
    document.forms.formMosaic.buttonLottery.disabled = true;
    if ('152' === document.forms.formMosaic.inputNetType.value) {
      visibleElement('buttonTransfer');
    }
    await refreshList();
    await startListen(
      document.forms.formMosaic.inputAddress.value,
      document.forms.formMosaic.inputNetType.value
    );
    intervalId = setInterval(refreshList, 10 * 1000);
  }
  async function onListenStopClick() {
    document.forms.formMosaic.buttonStop.disabled = true;
    document.forms.formMosaic.buttonStop.innerText = 'wait confirmed...';
    if ('152' === document.forms.formMosaic.inputNetType.value) {
      invisibleElement('buttonTransfer');
    }
    setTimeout(async () => {
      clearInterval(intervalId);
      intervalId = null;
      document.forms.formMosaic.buttonStop.innerText = 'Stop Listen';
      await stopListen();
      await refreshList();
      const list = await getAddressList();
      if (0 < list.length) {
        document.forms.formMosaic.buttonLottery.disabled = false;
      }
    }, 30 * 1000);
  }

  async function onExecuteTransfer() {
    window.open('https://testnet.symbol.tools/?recipient=' + document.forms.formMosaic.inputAddress.value + '&amount=1', '_blank');
  }

  async function onExecuteLottery() {
    visibleElement('loadArea', true);
    if (!(lotteryTransaction())) {
      console.log('all address selected.');
      return;
    }
    await setTimeout(async () => {
      invisibleElement('loadArea', false);
    }, 10 * 1000);
    await refreshList(true);
  }

  async function refreshList(forceRefresh = false) {
    const list = await getAddressList();

    const elementAddressList = document.getElementById("addressListArea");
    if (!(forceRefresh) && (list.length === elementAddressList.firstElementChild.childElementCount)) {
      return;
    }

    onChainDataElement = document.createElement('ul');
    onChainDataElement.setAttribute('class', 'list-group list-group-flush animate__animated animate__fadeIn');
    for (let index = 0; index < list.length; index++) {
      timestampElement = document.createElement('div');
      timestampElement.setAttribute('class', 'col-sm-4');
      timestampElement.innerText = list[index].time;
      addressElement = document.createElement('div');
      addressElement.setAttribute('class', 'col-sm-8');
      switch (list[index].state) {
        case -1:
        case 0:
          addressElement.innerText = list[index].address;
          break;
      
        default:
          addressElement.innerText = '[' + list[index].state + '] ' + list[index].address;
          break;
      }
      blankElement = document.createElement('div');
      blankElement.setAttribute('class', 'col-sm-4');
      messageElement = document.createElement('div');
      messageElement.setAttribute('class', 'col-sm-8');
      messageElement.innerText = list[index].message;
      rowElement = document.createElement('div');
      rowElement.setAttribute('class', 'row');
      rowElement.appendChild(timestampElement);
      rowElement.appendChild(addressElement);
      rowElement.appendChild(blankElement);
      rowElement.appendChild(messageElement);
      listItemElement = document.createElement('li');
      switch (list[index].state) {
        case -1:
        case 0:
          listItemElement.setAttribute('class', 'list-group-item');
          break;
      
        default:
          listItemElement.setAttribute('class', 'list-group-item list-group-item-election-' + list[index].state);
          break;
      }
      listItemElement.appendChild(rowElement);
      onChainDataElement.appendChild(listItemElement);
    }
    elementAddressList.removeChild(elementAddressList.firstElementChild);
    elementAddressList.appendChild(onChainDataElement);
  }

  async function createLoading() {
    loadingTextElement = document.createElement('h3');
    loadingTextElement.setAttribute('class', 'animate__animated animate__bounce animate__infinite');
    loadingTextElement.innerText = 'Now Lottery...';
    loadingHiddenElement = document.createElement('span');
    loadingHiddenElement.setAttribute('class', 'visually-hidden');
    loadingHiddenElement.innerText = 'Now Lottery...';
    loadingCycleElement = document.createElement('div');
    loadingCycleElement.setAttribute('class', 'spinner-border text-secondary');
    loadingCycleElement.setAttribute('role', 'status');
    loadingCycleElement.appendChild(loadingHiddenElement);
    loadingElement = document.createElement('div');
    loadingElement.setAttribute('class', 'position-fixed top-50 start-50 translate-middle text-center');
    loadingElement.appendChild(loadingTextElement);
    loadingElement.appendChild(loadingCycleElement);
    bgElement = document.createElement('div');
    bgElement.setAttribute('class', 'position-fixed top-50 start-50 translate-middle bg-white vw-100 vh-100 bg-1');
    bgElement.appendChild(loadingElement);

    const elementAddressList = document.getElementById("loadArea");
    elementAddressList.removeChild(elementAddressList.firstElementChild);
    elementAddressList.appendChild(onChainDataElement);
  }

  function visibleElement(elementId, fade = false) {
    loadArea = document.getElementById(elementId);
    loadArea.classList.add("d-block");
    if (fade) {
      loadArea.classList.add("animate__animated");
      loadArea.classList.add("animate__fadein");
    }
    loadArea.classList.remove("d-none");
  }

  function invisibleElement(elementId, fade = false) {
    loadArea = document.getElementById(elementId);
    loadArea.classList.add("d-none");
    loadArea.classList.remove("d-block");
    if (fade) {
      loadArea.classList.remove("animate__animated");
      loadArea.classList.remove("animate__fadein");
    }
  }
</script>

</html>